trigger:
  branches:
    include: 
    - master
variables:
  buildConfiguration: 'Release'
  location: 'westeurope'
  acrHostName: 'keyifydockertest.azurecr.io'
  acrName: 'keyifydockertest'
  rgName: 'keyifydockertest'
  imageName: 'keyifydockertest-image'
  webAppName: 'keyifydockertest'



stages:
- stage: BuildWindowsFilesAndTest
  displayName: Build Windows Files and Run Unit Test
  jobs:
  - job: BuildWindowsFilesAndTest
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: DotNetCoreCLI@2
      displayName: Build Tests
      inputs:
        command: 'build'
        projects: '**/*Unit.Test.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'
        
    - task: DotNetCoreCLI@2
      displayName: Restore Test Projects
      inputs:
        command: 'restore'
        projects: '**/*Unit.Test.dll'
        feedsToUse: 'select'
        
    - task: VSTest@3
      inputs:
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\*Unit.Test.dll
          !**\*TestAdapter.dll
          !**\obj\**
          !**\testhost*.*
          !**\Microsoft*.dll
        searchFolder: '$(System.DefaultWorkingDirectory)'
        runOnlyImpactedTests: false

- stage: BuildAndCreateImage
  displayName: Build and Create Image
  jobs:
  - job: BuildAndCreateImage
    pool:
      vmImage: 'ubuntu-latest'
    steps:    
    - task: DotNetCoreCLI@2
      displayName: Restore All Projects
      inputs:
        command: 'restore'
        projects: '**/*.csproj'
        feedsToUse: 'select'

    - task: DotNetCoreCLI@2
      displayName: Build Keyify.Web
      inputs:
        command: 'build'
        projects: '**/Keyify.Web.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # - task: DotNetCoreCLI@2
    #   displayName: Restore Tests
    #   inputs:
    #     command: 'restore'
    #     projects: '**/*Test.csproj'
    #     feedsToUse: 'select'

    - task: DotNetCoreCLI@2
      displayName: Build Tests
      inputs:
        command: 'build'
        projects: '**/*Unit.Test.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'
        
    # - task: DotNetCoreCLI@2
    #   displayName: Run Unit Tests
    #   inputs:
    #     command: 'test'
    #     projects: |
    #       **/*Unit.Test.dll
    #       !**\*TestAdapter.dll
    #       !**\obj\**
    #       !**\bin\**\ref\**
    #       !**\testhost*.*
    #       !**\Microsoft*.dll
    #     # arguments: '--configuration $(buildConfiguration) --no-restore'
    #     testRunTitle: 'Run Tests'

    # - task: DotNetCoreCLI@2
    #   displayName: 'Run Unit Tests (dotnet custom)'
    #   inputs:
    #     command: custom
    #     projects: '**/*Test.dll'
    #     custom: vstest
    #     arguments: '--logger:trx;logfilename=TEST.xml'